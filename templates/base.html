{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FlightFuel - Air Route Planner</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@8.2.0/ol.css">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{% static 'css/base.css' %}">
</head>
<body>
    <!-- TOP BAR -->
    <div class="top-bar">
        <div class="logo">
            <i class="fas fa-plane"></i>
            <span>FlightFuel</span>
        </div>
        
        <div class="search-container">
            <div class="search-box">
                <i class="fas fa-search search-icon"></i>
                <input type="text" id="globalSearch" placeholder="Search airports, waypoints, FIR...">
            </div>
            <button class="search-btn" id="searchButton">
                <i class="fas fa-search"></i> Search
            </button>
            
            <!-- Route Search Button -->
            <button class="search-btn" id="routeSearchBtn" style="margin-left: 10px;">
                <i class="fas fa-route"></i> Route Search
            </button>
        </div>
        
        <div style="margin-left: auto; display: flex; gap: 20px; align-items: center;">
            <button class="btn btn-primary" id="calculateFuel">
                <i class="fas fa-gas-pump"></i> Calculate Fuel
            </button>
            <div class="user-info">
                <i class="fas fa-user-circle" style="font-size: 24px; color: #5f6368;"></i>
            </div>
        </div>
    </div>

    <!-- MAIN APP CONTAINER -->
    <div class="app-container">
        <!-- LEFT SIDEBAR -->
        <aside class="sidebar" id="sidebar">
            <!-- Resize Handle -->
            <div class="resize-handle" id="resizeHandle"></div>
            
            <!-- Main sidebar content -->
            <div class="sidebar-content">
                <!-- Route Builder Section -->
                <div class="sidebar-section">
                    <h3 class="section-title">
                        <i class="fas fa-route"></i> Route Builder
                    </h3>
                    <div class="form-group">
                        <label for="departureSelect">Departure Airport</label>
                        <select id="departureSelect" class="airport-select">
                            <option value="">Select departure airport</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="arrivalSelect">Arrival Airport</label>
                        <select id="arrivalSelect" class="airport-select">
                            <option value="">Select arrival airport</option>
                        </select>
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-primary" id="showDirectRoute">
                            <i class="fas fa-paper-plane"></i> Show Route
                        </button>
                        <button class="btn btn-secondary" id="clearRoute">
                            <i class="fas fa-trash"></i> Clear
                        </button>
                    </div>
                </div>

                <!-- Layer Controls -->
                <div class="sidebar-section">
                    <h3 class="section-title">
                        <i class="fas fa-layer-group"></i> Layers
                    </h3>
                    <div class="layer-controls-grid">
                        <div class="layer-control">
                            <input type="checkbox" id="toggleAirports" checked>
                            <label for="toggleAirports">
                                <i class="fas fa-plane-departure"></i> Airports
                            </label>
                        </div>
                        <div class="layer-control">
                            <input type="checkbox" id="toggleWaypoints">
                            <label for="toggleWaypoints">
                                <i class="fas fa-map-marker-alt"></i> Waypoints
                            </label>
                        </div>
                        <div class="layer-control">
                            <input type="checkbox" id="toggleFIR">
                            <label for="toggleFIR">
                                <i class="fas fa-border-all"></i> FIR Regions
                            </label>
                        </div>
                        <div class="layer-control">
                            <input type="checkbox" id="toggleRoute">
                            <label for="toggleRoute">
                                <i class="fas fa-route"></i> Route
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Mode Selection -->
                <div class="sidebar-section">
                    <h3 class="section-title">
                        <i class="fas fa-cogs"></i> Mode
                        <span class="mode-status" id="modeStatus">VIEW</span>
                    </h3>
                    <div class="mode-buttons">
                        <button class="mode-btn active" id="viewMode">
                            <i class="fas fa-eye"></i> View
                            <div class="mode-btn-subtitle">Browse only</div>
                        </button>
                        <button class="mode-btn" id="editMode">
                            <i class="fas fa-edit"></i> Edit
                            <div class="mode-btn-subtitle">Modify & Save</div>
                        </button>
                    </div>
                    <div class="mode-hint" id="modeHint">
                        <i class="fas fa-info-circle"></i>
                        <span>You are in <strong>View Mode</strong>. Switch to Edit to modify routes.</span>
                    </div>
                </div>

                <!-- Route Information -->
                <div class="sidebar-section">
                    <div id="routeInfo" class="route-info-panel">
                        <h3 class="section-title">
                            <i class="fas fa-info-circle"></i> Route Information
                        </h3>
                        <div class="route-details" id="routeDetails"></div>
                    </div>
                </div>

                <!-- Edit Tools - SIMPLE VERSION -->
                <div class="sidebar-section">
                    <div id="editTools" class="edit-tools">
                        <h3 class="section-title">
                            <i class="fas fa-tools"></i> Edit Tools
                            <span class="edit-status" id="editStatusText">(Disabled)</span>
                        </h3>
                        
                        <!-- ÿØ⁄©ŸÖŸá ÿßÿµŸÑ€å Enable/Disable -->
                        <button class="btn-edit-main" id="btnToggleEdit">
                            <i class="fas fa-lock-open"></i>
                            <span>Enable Editing</span>
                            <small>Click to start modifying route</small>
                        </button>
                        
                        <!-- ÿØ⁄©ŸÖŸá‚ÄåŸáÿß€å Save -->
                        <div class="save-buttons">
                            <button class="btn-save" id="btnSave">
                                <i class="fas fa-save"></i> Save
                            </button>
                            <button class="btn-save-as" id="btnSaveAs">
                                <i class="fas fa-copy"></i> Save As
                            </button>
                        </div>
                        
                        <!-- ÿ±ÿßŸáŸÜŸÖÿß€å ÿ≥ÿßÿØŸá -->
                        <div class="edit-hint" id="editHint">
                            <i class="fas fa-info-circle"></i>
                            Switch to <strong>Edit Mode</strong> first, then click Enable Editing
                        </div>
                    </div>
                </div>

                <!-- Import Route -->
                <div class="sidebar-section">
                    <div class="import-section">
                        <h3 class="section-title">
                            <i class="fas fa-file-import"></i> Import Route
                        </h3>
                        <textarea id="routeText" placeholder="Paste your route here (e.g. OIIE DHN1E DHN B411 ITELO L720 RIKOP...)" 
                                  rows="3"></textarea>
                        <button class="btn btn-warning" id="importRouteBtn">
                            <i class="fas fa-upload"></i> Import Route
                        </button>
                        <div class="status-message" id="importResult"></div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- MAIN MAP AREA -->
        <main class="map-container">
            <div id="map" class="map"></div>
            
            <!-- Map Controls -->
            <div class="map-controls">
                <div class="control-group">
                    <button class="control-btn" id="zoomIn" title="Zoom In">
                        <i class="fas fa-plus"></i>
                    </button>
                    <button class="control-btn" id="zoomOut" title="Zoom Out">
                        <i class="fas fa-minus"></i>
                    </button>
                    <button class="control-btn" id="resetView" title="Reset View">
                        <i class="fas fa-home"></i>
                    </button>
                    <button class="control-btn" id="measureTool" title="Measure Distance">
                        <i class="fas fa-ruler"></i>
                    </button>
                    <button class="control-btn" id="panTool" title="Pan Tool">
                        <i class="fas fa-hand-paper"></i>
                    </button>
                    <button class="control-btn active" id="selectTool" title="Select Tool">
                        <i class="fas fa-mouse-pointer"></i>
                    </button>
                </div>
            </div>

            <!-- Tooltip Overlays -->
            <div class="fir-tooltip" style="display: none;"></div>
            <div class="wp-tooltip" style="display: none;"></div>
        </main>
    </div>

    <!-- ROUTE SEARCH MODAL -->
    <div class="route-search-modal" id="routeSearchModal">
        <div class="route-search-content">
            <div class="route-search-header">
                <h2><i class="fas fa-route"></i> Route Search</h2>
                <button class="close-search-modal" id="closeRouteSearchModal">
                    &times;
                </button>
            </div>
            
            <div class="search-form">
                <div class="search-input-group">
                    <input type="text" 
                           id="searchOrigin" 
                           class="search-input" 
                           placeholder="Origin IATA/ICAO (e.g., THR or OIII)"
                           maxlength="4"
                           autocapitalize="characters"
                           title="Enter 3-letter IATA code (e.g., THR) or 4-letter ICAO code (e.g., OIII)">
                    
                    <button class="search-swap-btn" id="swapSearchInputs" title="Swap origin/destination">
                        <i class="fas fa-exchange-alt"></i>
                    </button>
                    
                    <input type="text" 
                           id="searchDestination" 
                           class="search-input" 
                           placeholder="Destination IATA/ICAO (e.g., MHD or OIMM)"
                           maxlength="4"
                           autocapitalize="characters"
                           title="Enter 3-letter IATA code (e.g., MHD) or 4-letter ICAO code (e.g., OIMM)">
                </div>
                
                <div style="font-size: 12px; color: #666; margin: 8px 0; text-align: center;">
                    <i class="fas fa-info-circle"></i> Enter 3-letter IATA (THR) or 4-letter ICAO (OIII) codes
                </div>
                
                <button class="search-submit-btn" id="executeRouteSearch">
                    <i class="fas fa-search"></i> Search Routes
                </button>
            </div>
            
            <div class="loading-spinner" id="searchLoadingSpinner">
                <div class="spinner"></div>
                <p>Searching for routes...</p>
            </div>
            
            <div class="search-results-container" id="routeSearchResults">
                <div class="search-results-header">
                    <span>Search Results</span>
                    <span class="results-count" id="resultsCount">0</span>
                </div>
                <div id="searchResultsContent">
                    <div class="no-results">
                        <i class="fas fa-route"></i>
                        <h4>No Search Yet</h4>
                        <p>Enter origin and destination airport codes to search for saved routes.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- SAVE ROUTE MODAL -->
    <div class="save-route-modal" id="saveRouteModal">
        <div class="save-route-content">
            <div class="save-route-header">
                <h2><i class="fas fa-save" id="saveModalIcon"></i> <span id="saveModalTitle">Save Route</span></h2>
                <button class="close-search-modal" id="closeSaveModal">
                    &times;
                </button>
            </div>
            
            <div class="save-route-body">
                <div class="form-group">
                    <label for="routeNameInput" style="display: block; margin-bottom: 8px; font-weight: 600; color: #202124;">
                        Route Name
                    </label>
                    <input type="text" id="routeNameInput" class="route-name-input" 
                           placeholder="Enter a descriptive name for this route">
                </div>
                
                <div class="save-option-group" id="saveOptionsGroup">
                    <div class="save-option">
                        <input type="radio" id="saveOptionNew" name="saveOption" value="new" checked>
                        <label for="saveOptionNew">
                            <i class="fas fa-file-alt"></i> Save as New Route
                        </label>
                    </div>
                    <div class="save-option-desc">
                        Create a new route with this name. Existing routes will not be affected.
                    </div>
                    
                    <div class="save-option">
                        <input type="radio" id="saveOptionOverwrite" name="saveOption" value="overwrite">
                        <label for="saveOptionOverwrite">
                            <i class="fas fa-sync-alt"></i> Overwrite Existing Route
                        </label>
                    </div>
                    <div class="save-option-desc">
                        Replace an existing route with the same name.
                    </div>
                </div>
                
                <div class="save-actions">
                    <button class="save-btn save-btn-cancel" id="cancelSaveBtn">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                    <button class="save-btn save-btn-confirm" id="confirmSaveBtn">
                        <i class="fas fa-check"></i> Save Route
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- SCRIPTS -->
    <script src="https://cdn.jsdelivr.net/npm/ol@8.2.0/dist/ol.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script>
        // ==================== INITIALIZATION ====================
        console.log('üöÄ FlightFuel Application Initializing...');

        // ==================== GLOBALS ====================
        const map = new ol.Map({
            target: 'map',
            layers: [
                new ol.layer.Tile({
                    source: new ol.source.OSM({
                        url: 'https://{a-c}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png'
                    })
                })
            ],
            view: new ol.View({
                center: ol.proj.fromLonLat([51.3890, 35.6892]),
                zoom: 5
            }),
            controls: []
        });

        // ==================== EDIT STATE ====================
        let isEditingEnabled = false;

        // ==================== SAVE ROUTE SYSTEM ====================
        let currentRouteToSave = null;
        let currentSaveAction = ''; // 'save' or 'saveAs'

        function showSaveRouteModal(isSaveAs = false) {
            currentSaveAction = isSaveAs ? 'saveAs' : 'save';
            
            const modal = document.getElementById('saveRouteModal');
            const modalTitle = document.getElementById('saveModalTitle');
            const modalIcon = document.getElementById('saveModalIcon');
            const saveOptionsGroup = document.getElementById('saveOptionsGroup');
            const confirmBtn = document.getElementById('confirmSaveBtn');
            
            if (isSaveAs) {
                modalTitle.textContent = 'Save As New Route';
                confirmBtn.innerHTML = '<i class="fas fa-check"></i> Save As New';
                saveOptionsGroup.style.display = 'none';
            } else {
                modalTitle.textContent = 'Save Route';
                confirmBtn.innerHTML = '<i class="fas fa-check"></i> Save Route';
                saveOptionsGroup.style.display = 'block';
            }
            
            // ÿ™ŸÜÿ∏€åŸÖ ŸÜÿßŸÖ Ÿæ€åÿ¥ŸÜŸáÿßÿØ€å
            const routeNameInput = document.getElementById('routeNameInput');
            if (currentRouteToSave && currentRouteToSave.departure && currentRouteToSave.arrival) {
                routeNameInput.value = `${currentRouteToSave.departure}-${currentRouteToSave.arrival}`;
            } else {
                routeNameInput.value = '';
            }
            
            // ÿßŸÜÿ™ÿÆÿßÿ® ⁄Øÿ≤€åŸÜŸá Ÿæ€åÿ¥‚ÄåŸÅÿ±ÿ∂
            document.getElementById('saveOptionNew').checked = true;
            
            modal.classList.add('active');
            routeNameInput.focus();
            routeNameInput.select();
        }

        function closeSaveRouteModal() {
            document.getElementById('saveRouteModal').classList.remove('active');
            currentRouteToSave = null;
            currentSaveAction = '';
        }

async function executeSaveWithName() {
    try {
        console.log('üîç Starting save process...');
        
        // Check if route name is provided
        const routeName = document.getElementById('routeNameInput').value.trim();
        if (!routeName) {
            showStatus('Please enter a route name', 'error');
            return;
        }
        
        // ======== CRITICAL FIX: Check if currentRouteToSave exists ========
        if (!currentRouteToSave) {
            console.error('‚ùå currentRouteToSave is null! Cannot save route.');
            showStatus('‚ùå Route data not found. Please create route and click Save button first.', 'error');
            closeSaveRouteModal();
            return;
        }
        
        // Validate required fields
        if (!currentRouteToSave.departure || !currentRouteToSave.arrival || !currentRouteToSave.coordinates) {
            showStatus('‚ùå Route data is incomplete. Please recreate the route.', 'error');
            closeSaveRouteModal();
            return;
        }
        
        // Determine save type (new or overwrite)
        let saveType = 'new';
        if (currentSaveAction === 'save') {
            const selectedOption = document.querySelector('input[name="saveOption"]:checked');
            saveType = selectedOption ? selectedOption.value : 'new';
        }
        
        // Prepare data for API request
        const routeData = {
            name: routeName,
            departure: currentRouteToSave.departure,
            arrival: currentRouteToSave.arrival,
            coordinates: currentRouteToSave.coordinates,
            total_distance: parseFloat(currentRouteToSave.totalDistance.toFixed(2)),
            flight_time: calculateFlightTime(currentRouteToSave.totalDistance),
            version: document.getElementById('routeVersionInput')?.value.trim() || '',
            description: `Saved via FlightFuel on ${new Date().toLocaleString()}`
        };
        
        console.log('üì§ Saving route:', { 
            routeName: routeData.name,
            departure: routeData.departure,
            arrival: routeData.arrival,
            coordinatesCount: routeData.coordinates.length,
            saveType: saveType,
            action: currentSaveAction 
        });
        
        // Determine API endpoint based on save action
        let apiUrl = '/api/save-route/';
        if (currentSaveAction === 'saveAs') {
            apiUrl = '/api/save-route-as/';
        }
        
        // Send request to server
        const response = await fetch(apiUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(routeData)
        });
        
        // Check response status
        if (!response.ok) {
            const errorText = await response.text();
            console.error('‚ùå Server response error:', errorText);
            throw new Error(`HTTP ${response.status}: ${errorText}`);
        }
        
        const data = await response.json();
        
        // Handle server response
        if (data.status === 'success') {
            // Update current route feature with new name BEFORE clearing
            if (currentRouteToSave && currentRouteToSave.feature) {
                currentRouteToSave.feature.set('name', routeName);
                updateRouteInfo();
            }
            
            // Show success message
            const actionMsg = currentSaveAction === 'saveAs' ? 'saved as new copy' : 'saved';
            showStatus(`‚úÖ Route "${routeName}" ${actionMsg} successfully!`, 'success');
            
            // Close modal AFTER all operations
            closeSaveRouteModal();
            
            // Clear saved data AFTER success
            currentRouteToSave = null;
            currentSaveAction = '';
            
        } else {
            // Server returned error status
            showStatus(`‚ùå Error: ${data.message}`, 'error');
        }
        
    } catch (error) {
        console.error('‚ùå Save process failed:', error);
        showStatus(`‚ùå Save failed: ${error.message}`, 'error');
    }
}

        // ==================== SIMPLE EDIT TOGGLE ====================
        function toggleEditing() {
            const routeSource = routeLayer.getSource();
            const routeFeatures = routeSource.getFeatures();
            
            if (routeFeatures.length === 0) {
                showStatus('‚ùå Please create a route first', 'error');
                return;
            }
            
            if (!isEditingEnabled) {
                // Enable Editing
                enableRouteEditing();
                document.getElementById('btnToggleEdit').classList.add('active');
                document.getElementById('btnToggleEdit').innerHTML = `
                    <i class="fas fa-lock"></i>
                    <span>Disable Editing</span>
                    <small>Click to stop modifying</small>
                `;
                document.getElementById('editStatusText').textContent = '(Active)';
                document.getElementById('editStatusText').className = 'edit-status active';
                document.getElementById('editHint').innerHTML = `
                    <i class="fas fa-check-circle"></i>
                    Editing enabled! Drag the <strong>red points</strong> to modify route
                `;
                document.getElementById('editHint').classList.add('active');
                isEditingEnabled = true;
                
            } else {
                // Disable Editing
                disableRouteEditing();
                document.getElementById('btnToggleEdit').classList.remove('active');
                document.getElementById('btnToggleEdit').innerHTML = `
                    <i class="fas fa-lock-open"></i>
                    <span>Enable Editing</span>
                    <small>Click to start modifying route</small>
                `;
                document.getElementById('editStatusText').textContent = '(Disabled)';
                document.getElementById('editStatusText').className = 'edit-status';
                document.getElementById('editHint').innerHTML = `
                    <i class="fas fa-info-circle"></i>
                    Click <strong>Enable Editing</strong> to modify route points
                `;
                document.getElementById('editHint').classList.remove('active');
                isEditingEnabled = false;
            }
        }

        // ==================== EDIT TOOLS FUNCTIONS ====================
        function enableRouteEditing() {
            const routeSource = routeLayer.getSource();
            const routeFeatures = routeSource.getFeatures();
            
            if (routeFeatures.length === 0) {
                showStatus('‚ùå Please create a route first', 'error');
                return;
            }
            
            removeAllInteractions();
            
            modifyInteraction = new ol.interaction.Modify({
                source: routeLayer.getSource(),
                style: new ol.style.Style({
                    image: new ol.style.Circle({
                        radius: 8,
                        fill: new ol.style.Fill({color: '#ea4335'}),
                        stroke: new ol.style.Stroke({color: 'white', width: 2})
                    })
                }),
                condition: function(event) {
                    return ol.events.condition.primaryAction(event) && 
                           ol.events.condition.noModifierKeys(event) &&
                           !ol.events.condition.singleClick(event);
                }
            });

            snapInteraction = new ol.interaction.Snap({
                source: waypointLayer.getSource(),
                pixelTolerance: 10
            });

            map.addInteraction(modifyInteraction);
            map.addInteraction(snapInteraction);
            
            showStatus('‚úÖ Route editing enabled. Drag red points to modify.', 'success');
        }

        function disableRouteEditing() {
            removeAllInteractions();
            activateTool('select');
            showStatus('Route editing disabled', 'info');
        }

        // ==================== MODE MANAGEMENT ====================
        let currentMode = 'view';

        function updateModeUI() {
            const modeStatus = document.getElementById('modeStatus');
            const modeHint = document.getElementById('modeHint');
            
            if (currentMode === 'view') {
                document.getElementById('viewMode').classList.add('active');
                document.getElementById('editMode').classList.remove('active');
                
                if (modeStatus) {
                    modeStatus.textContent = 'VIEW';
                    modeStatus.className = 'mode-status';
                }
                
                if (modeHint) {
                    modeHint.innerHTML = `
                        <i class="fas fa-info-circle"></i>
                        <span>You are in <strong>View Mode</strong>. Switch to Edit to modify routes.</span>
                    `;
                }
                
                // ŸÖÿÆŸÅ€å ⁄©ÿ±ÿØŸÜ Edit Tools
                document.getElementById('editTools').style.display = 'none';
                if (isEditingEnabled) {
                    toggleEditing();
                }
                
            } else {
                document.getElementById('editMode').classList.add('active');
                document.getElementById('viewMode').classList.remove('active');
                
                if (modeStatus) {
                    modeStatus.textContent = 'EDIT';
                    modeStatus.className = 'mode-status edit';
                }
                
                if (modeHint) {
                    modeHint.innerHTML = `
                        <i class="fas fa-info-circle"></i>
                        <span>You are in <strong>Edit Mode</strong>. You can now modify and save routes.</span>
                    `;
                }
                
                // ŸÜŸÖÿß€åÿ¥ Edit Tools
                document.getElementById('editTools').style.display = 'block';
            }
        }

        // ==================== SAVE ROUTE ====================
function saveCurrentRoute(isSaveAs = false) {
    try {
        console.log('üíæ Save requested:', { isSaveAs });
        
        // Check if route exists
        const routeFeatures = routeLayer.getSource().getFeatures();
        if (routeFeatures.length === 0) {
            showStatus('‚ùå No route to save', 'error');
            return;
        }
        
        const latestRouteFeature = routeFeatures[routeFeatures.length - 1];
        if (!latestRouteFeature) {
            showStatus('‚ùå Route feature not found', 'error');
            return;
        }
        
        // Check geometry
        const geometry = latestRouteFeature.getGeometry();
        if (!geometry) {
            showStatus('‚ùå Route has no geometry', 'error');
            return;
        }
        
        // Calculate coordinates and distance
        const coordinates = geometry.getCoordinates();
        const lonLatCoordinates = coordinates.map(coord => ol.proj.toLonLat(coord));
        
        let totalDistance = 0;
        for (let i = 0; i < lonLatCoordinates.length - 1; i++) {
            const coord1 = lonLatCoordinates[i];
            const coord2 = lonLatCoordinates[i + 1];
            totalDistance += calculateDistance(coord1, coord2);
        }
        
        // === FIXED: Get airport codes properly ===
        let departure = '';
        let arrival = '';
        
        // Method 1: Get from feature properties (when loaded from search)
        const props = latestRouteFeature.getProperties();
        departure = props.departure || '';
        arrival = props.arrival || '';
        
        // Method 2: Get from select boxes (when created manually)
        if (!departure || !arrival) {
            departure = $('#departureSelect').val();
            arrival = $('#arrivalSelect').val();
        }
        
        // Method 3: Try to parse from select2 data
        if (!departure || !arrival) {
            const depSelect = $('#departureSelect').select2('data');
            const arrSelect = $('#arrivalSelect').select2('data');
            
            if (depSelect && depSelect[0] && !departure) {
                departure = depSelect[0].id || depSelect[0].text;
            }
            if (arrSelect && arrSelect[0] && !arrival) {
                arrival = arrSelect[0].id || arrSelect[0].text;
            }
        }
        
        // Method 4: Last resort - extract from text
        if (!departure || !arrival) {
            const depText = $('#departureSelect option:selected').text();
            const arrText = $('#arrivalSelect option:selected').text();
            
            // Extract code from text like "Tehran (THR/OIII)"
            const extractCode = (text) => {
                if (!text) return '';
                // Try IATA code (3 letters)
                const iataMatch = text.match(/\(([A-Z]{3})\//);
                if (iataMatch) return iataMatch[1];
                // Try ICAO code (4 letters)
                const icaoMatch = text.match(/\/([A-Z]{4})\)/);
                if (icaoMatch) return icaoMatch[1];
                return '';
            };
            
            if (!departure) departure = extractCode(depText);
            if (!arrival) arrival = extractCode(arrText);
        }
        
        // Final check
        if (!departure || !arrival) {
            showStatus('‚ùå Please select departure and arrival airports', 'error');
            return;
        }
        
        // Clean codes (remove extra characters)
        departure = departure.replace(/[^A-Z]/g, '').substring(0, 4);
        arrival = arrival.replace(/[^A-Z]/g, '').substring(0, 4);
        
        console.log('‚úÖ Airport codes:', { departure, arrival });
        
        // Prepare data for saving
        currentRouteToSave = {
            isSaveAs: isSaveAs,
            coordinates: lonLatCoordinates,
            totalDistance: totalDistance,
            departure: departure,
            arrival: arrival,
            feature: latestRouteFeature
        };
        
        // Show save modal
        showSaveRouteModal(isSaveAs);
        
    } catch (error) {
        console.error('‚ùå Error in saveCurrentRoute:', error);
        showStatus(`‚ùå Save error: ${error.message}`, 'error');
    }
}

        
        // ==================== AIRPORT LAYER ====================
        const airportSource = new ol.source.Vector({
            loader: function(extent, resolution, projection) {
                fetch('/api/airports/')
                    .then(response => response.json())
                    .then(data => {
                        try {
                            if (data && data.features) {
                                data.features.forEach(feature => {
                                    if (feature && !feature.type) {
                                        feature.type = 'Feature';
                                    }
                                    if (feature && !feature.properties) {
                                        feature.properties = {};
                                    }
                                });
                                
                                const features = new ol.format.GeoJSON().readFeatures(data, {
                                    featureProjection: 'EPSG:3857'
                                });
                                airportSource.addFeatures(features);
                                console.log(`‚úÖ Airports loaded: ${features.length} features`);
                            }
                        } catch (e) {
                            console.error('‚ùå Error parsing airport GeoJSON:', e);
                        }
                    })
                    .catch(error => {
                        console.error('‚ùå Failed to fetch airports:', error);
                    });
            },
            strategy: ol.loadingstrategy.bbox
        });

        const airportLayer = new ol.layer.Vector({
            source: airportSource,
            visible: true,
            style: new ol.style.Style({
                image: new ol.style.Circle({
                    radius: 6,
                    fill: new ol.style.Fill({color: '#1a73e8'}),
                    stroke: new ol.style.Stroke({color: 'white', width: 2})
                })
            })
        });
        map.addLayer(airportLayer);

        const waypointLayer = new ol.layer.Vector({
            source: new ol.source.Vector({
                url: '/api/waypoints/',
                format: new ol.format.GeoJSON()
            }),
            visible: false,
            style: function(feature) {
                const type = feature.get('type');
                let color, icon;
                
                switch(type) {
                    case 'VOR':
                        color = '#FF6B35';
                        icon = 'V';
                        break;
                    case 'NDB':
                        color = '#34a853';
                        icon = 'N';
                        break;
                    case 'AIRPORT':
                        color = '#1a73e8';
                        icon = 'A';
                        break;
                    default:
                        color = '#5f6368';
                        icon = 'W';
                }
                
                return new ol.style.Style({
                    image: new ol.style.Circle({
                        radius: 5,
                        fill: new ol.style.Fill({color: color}),
                        stroke: new ol.style.Stroke({color: 'white', width: 1.5})
                    }),
                    text: new ol.style.Text({
                        text: feature.get('identifier') + ' ' + icon,
                        offsetY: -10,
                        fill: new ol.style.Fill({color: color}),
                        stroke: new ol.style.Stroke({color: 'white', width: 2}),
                        font: 'bold 11px Arial'
                    })
                });
            }
        });
        map.addLayer(waypointLayer);

        const firLayer = new ol.layer.Vector({
            source: new ol.source.Vector({
                url: '/api/fir-geojson/',
                format: new ol.format.GeoJSON()
            }),
            visible: false,
            style: function(feature) {
                const identifier = feature.get('identifier');
                
                return new ol.style.Style({
                    stroke: new ol.style.Stroke({
                        color: 'rgba(234, 67, 53, 0.7)',
                        width: 2,
                        lineDash: [5, 5]
                    }),
                    fill: new ol.style.Fill({
                        color: 'rgba(234, 67, 53, 0.1)'
                    }),
                    text: new ol.style.Text({
                        text: identifier,
                        fill: new ol.style.Fill({color: '#ea4335'}),
                        stroke: new ol.style.Stroke({color: 'white', width: 2}),
                        offsetY: -20,
                        font: 'bold 12px Arial',
                        overflow: true
                    })
                });
            }
        });
        map.addLayer(firLayer);

        const routeLayer = new ol.layer.Vector({
            source: new ol.source.Vector(),
            visible: false,
            style: new ol.style.Style({
                stroke: new ol.style.Stroke({
                    color: '#1a73e8',
                    width: 3,
                    lineDash: [5, 5]
                }),
                image: new ol.style.Circle({
                    radius: 6,
                    fill: new ol.style.Fill({color: '#1a73e8'}),
                    stroke: new ol.style.Stroke({color: 'white', width: 2})
                })
            })
        });
        map.addLayer(routeLayer);

        // ==================== TOOLTIPS ====================
        const firTooltipElement = document.createElement('div');
        firTooltipElement.className = 'fir-tooltip';
        const firTooltipOverlay = new ol.Overlay({
            element: firTooltipElement,
            positioning: 'bottom-center',
            offset: [0, -10],
            stopEvent: false
        });
        map.addOverlay(firTooltipOverlay);

        const wpTooltipElement = document.createElement('div');
        wpTooltipElement.className = 'wp-tooltip';
        const wpTooltipOverlay = new ol.Overlay({
            element: wpTooltipElement,
            positioning: 'bottom-center',
            offset: [0, -15],
            stopEvent: false
        });
        map.addOverlay(wpTooltipOverlay);
        // ==================== MAP INTERACTIONS ====================
        let modifyInteraction = null;
        let snapInteraction = null;
        let routeFeature = null;
        let drawInteraction = null;
        let measureInteraction = null;
        let currentTool = 'select';

        // ==================== UTILITY FUNCTIONS ====================
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        function calculateDistance(coord1, coord2) {
            const [lon1, lat1] = coord1;
            const [lon2, lat2] = coord2;
            
            const R = 3440.065;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            
            const a = 
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
                Math.sin(dLon/2) * Math.sin(dLon/2);
            
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function calculateFlightTime(distanceNm) {
            const hours = distanceNm / 450;
            const hourInt = Math.floor(hours);
            const minuteInt = Math.round((hours - hourInt) * 60);
            
            return `${hourInt.toString().padStart(2, '0')}:${minuteInt.toString().padStart(2, '0')}`;
        }

        function showStatus(message, type) {
            const statusDiv = document.createElement('div');
            statusDiv.className = `status-message status-${type}`;
            statusDiv.innerHTML = message;
            statusDiv.style.position = 'fixed';
            statusDiv.style.bottom = '20px';
            statusDiv.style.right = '20px';
            statusDiv.style.zIndex = '10000';
            statusDiv.style.maxWidth = '300px';
            document.body.appendChild(statusDiv);
            
            setTimeout(() => {
                statusDiv.remove();
            }, 3000);
        }

        // ==================== IATA TO ICAO CONVERSION ====================
        async function convertToIcaoIfNeeded(code) {
            code = code.toUpperCase().trim();
            
            if (code.length === 4 && /^[A-Z]+$/.test(code)) {
                console.log(`‚úÖ ${code} is already ICAO`);
                return code;
            }
            
            if (code.length === 3 && /^[A-Z]+$/.test(code)) {
                try {
                    const airports = await getAirportsCache();
                    const airport = airports.find(a => a.iata === code);
                    
                    if (airport && airport.icao) {
                        console.log(`‚úÖ Converted IATA to ICAO: ${code} ‚Üí ${airport.icao}`);
                        return airport.icao;
                    }
                    
                    const response = await fetch(`/api/airports/search/?code=${code}`);
                    if (response.ok) {
                        const data = await response.json();
                        if (data.icao) {
                            console.log(`‚úÖ Converted IATA to ICAO via API: ${code} ‚Üí ${data.icao}`);
                            return data.icao;
                        }
                    }
                    
                    console.warn(`‚ö†Ô∏è IATA code not found: ${code}`);
                    return code;
                    
                } catch (error) {
                    console.warn(`‚ö†Ô∏è Error converting ${code}:`, error);
                    return code;
                }
            }
            
            return code;
        }

        async function getAirportsCache() {
            const CACHE_KEY = 'airports_data';
            const CACHE_EXPIRY = 24 * 60 * 60 * 1000;
            
            const cached = localStorage.getItem(CACHE_KEY);
            if (cached) {
                const { data, timestamp } = JSON.parse(cached);
                if (Date.now() - timestamp < CACHE_EXPIRY) {
                    return data;
                }
            }
            
            try {
                const response = await fetch('/api/airports/');
                if (response.ok) {
                    const geojson = await response.json();
                    const airports = geojson.features.map(f => ({
                        iata: f.properties.iata,
                        icao: f.properties.icao,
                        name: f.properties.name,
                        city: f.properties.city,
                        country: f.properties.country
                    }));
                    
                    localStorage.setItem(CACHE_KEY, JSON.stringify({
                        data: airports,
                        timestamp: Date.now()
                    }));
                    
                    console.log(`‚úÖ Airports cache loaded: ${airports.length} airports`);
                    return airports;
                }
            } catch (error) {
                console.error('‚ùå Error loading airports cache:', error);
            }
            
            return [];
        }

        // ==================== ROUTE SEARCH FUNCTIONS ====================
async function executeRouteSearch() {
    try {
        const originInput = document.getElementById('searchOrigin').value.trim().toUpperCase();
        const destinationInput = document.getElementById('searchDestination').value.trim().toUpperCase();
        
        console.log('üîç Searching:', originInput, '‚Üí', destinationInput);
        
        if (!originInput || !destinationInput) {
            showStatus('Please enter both origin and destination', 'error');
            return;
        }
        
        if (originInput === destinationInput) {
            showStatus('Origin and destination cannot be the same', 'error');
            return;
        }
        
        const loadingSpinner = document.getElementById('searchLoadingSpinner');
        const searchButton = document.getElementById('executeRouteSearch');
        const resultsContainer = document.getElementById('searchResultsContent');
        const resultsCount = document.getElementById('resultsCount');
        
        if (!loadingSpinner || !searchButton || !resultsContainer) {
            console.error('‚ùå UI elements not found!');
            return;
        }
        
        // Show loading
        loadingSpinner.classList.add('active');
        searchButton.disabled = true;
        resultsContainer.innerHTML = '<div class="loading-text">Searching...</div>';
        resultsCount.textContent = '0';
        
        // Call API
        console.log('üìû Calling API...');
        const response = await fetch(`/api/route-search/?origin=${originInput}&destination=${destinationInput}`);
        
        console.log('üì• API Response status:', response.status);
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        console.log('‚úÖ API Response data:', data);
        
        // Hide loading
        loadingSpinner.classList.remove('active');
        searchButton.disabled = false;
        
        // Display results
        if (data.status === 'error') {
            showStatus(data.message, 'error');
            resultsContainer.innerHTML = `
                <div class="no-results">
                    <i class="fas fa-exclamation-triangle"></i>
                    <h4>Search Error</h4>
                    <p>${data.message}</p>
                </div>
            `;
        } else {
            // SUCCESS - Show results
            console.log('üéØ Found routes:', data.count);
            showStatus(`Found ${data.count} route(s)`, 'success');
            resultsCount.textContent = data.count;
            
            if (data.count === 0) {
                resultsContainer.innerHTML = `
                    <div class="no-results">
                        <i class="fas fa-search"></i>
                        <h4>No Routes Found</h4>
                        <p>No saved routes found from ${originInput} to ${destinationInput}.</p>
                    </div>
                `;
            } else {
                // Build HTML for results
                let html = '';
                data.routes.forEach((route, index) => {
                    html += `
                        <div class="route-result-item" data-route-id="${route.id}">
                            <div class="route-result-header">
                                <div class="route-title">
                                    <i class="fas fa-route"></i>
                                    ${route.name}
                                </div>
                                <div class="route-distance">${route.total_distance ? route.total_distance.toFixed(1) + ' NM' : 'N/A'}</div>
                            </div>
                            
                            <div class="route-details-grid">
                                <div class="route-detail-item">
                                    <i class="fas fa-plane-departure"></i>
                                    <strong>Origin:</strong>
                                    <span class="route-icao">${route.departure}</span>
                                </div>
                                <div class="route-detail-item">
                                    <i class="fas fa-plane-arrival"></i>
                                    <strong>Destination:</strong>
                                    <span class="route-icao">${route.arrival}</span>
                                </div>
                                <div class="route-detail-item">
                                    <i class="fas fa-clock"></i>
                                    <strong>Flight Time:</strong>
                                    <span>${route.flight_time || 'N/A'}</span>
                                </div>
                                <div class="route-detail-item">
                                    <i class="fas fa-calendar"></i>
                                    <strong>Created:</strong>
                                    <span>${route.created_at}</span>
                                </div>
                            </div>
                            
                            <div class="route-actions">
                                <button class="load-route-btn" onclick="window.loadRouteFromSearch(${route.id})">
                                    <i class="fas fa-map-marker-alt"></i> Load on Map
                                </button>
                                <button class="view-details-btn" onclick="window.viewRouteDetails(${route.id})">
                                    <i class="fas fa-info-circle"></i> Details
                                </button>
                            </div>
                        </div>
                    `;
                });
                
                resultsContainer.innerHTML = html;
                console.log('‚úÖ Results displayed');
            }
        }
        
    } catch (error) {
        console.error('‚ùå Route search error:', error);
        
        const loadingSpinner = document.getElementById('searchLoadingSpinner');
        const searchButton = document.getElementById('executeRouteSearch');
        const resultsContainer = document.getElementById('searchResultsContent');
        
        if (loadingSpinner) loadingSpinner.classList.remove('active');
        if (searchButton) searchButton.disabled = false;
        
        if (resultsContainer) {
            resultsContainer.innerHTML = `
                <div class="no-results">
                    <i class="fas fa-exclamation-triangle"></i>
                    <h4>Search Error</h4>
                    <p>Failed to search routes. Please try again.</p>
                    <p style="font-size: 12px; margin-top: 10px; color: #dc3545;">
                        Error: ${error.message}
                    </p>
                </div>
            `;
        }
        
        showStatus('Error searching routes', 'error');
    }
}

function displayRouteSearchResults(routes, originalOrigin, originalDestination, data = {}) {
    console.log('üîÑ Displaying search results...');
    
    const resultsContainer = document.getElementById('searchResultsContent');
    const resultsCount = document.getElementById('resultsCount');
    
    if (!resultsContainer || !resultsCount) {
        console.error('‚ùå Results container not found!');
        return;
    }
    
    console.log('üîç Found routes:', routes.length);
    
    if (!routes || routes.length === 0) {
        let searchInfo = '';
        if (data.search) {
            const { origin_icao, destination_icao } = data.search;
            if (origin_icao && origin_icao !== originalOrigin) {
                searchInfo += `<div class="conversion-info">Origin converted: ${originalOrigin} ‚Üí ${origin_icao}</div>`;
            }
            if (destination_icao && destination_icao !== originalDestination) {
                searchInfo += `<div class="conversion-info">Destination converted: ${originalDestination} ‚Üí ${destination_icao}</div>`;
            }
        }
        
        resultsContainer.innerHTML = `
            <div class="no-results">
                <i class="fas fa-search"></i>
                <h4>No Routes Found</h4>
                <p>No saved routes found from ${originalOrigin} to ${originalDestination}.</p>
                ${searchInfo}
            </div>
        `;
        resultsCount.textContent = '0';
        return;
    }
    
    // ÿß⁄Øÿ± routes Ÿàÿ¨ŸàÿØ ÿØÿßÿ±ÿØ
    resultsCount.textContent = routes.length;
    
    let html = '';
    routes.forEach((route, index) => {
        const routeName = route.name || `Route ${route.departure} to ${route.arrival}`;
        const distance = route.total_distance ? `${route.total_distance.toFixed(1)} NM` : 'N/A';
        const flightTime = route.flight_time || 'N/A';
        const waypointCount = route.waypoints ? route.waypoints.length : 0;
        const createdDate = route.created_at ? new Date(route.created_at).toLocaleDateString() : 'Unknown';
        const createdBy = route.created_by || 'Unknown';
        
        html += `
            <div class="route-result-item" data-route-id="${route.id}">
                <div class="route-result-header">
                    <div class="route-title">
                        <i class="fas fa-route"></i>
                        ${routeName}
                    </div>
                    <div class="route-distance">${distance}</div>
                </div>
                
                <div class="route-details-grid">
                    <div class="route-detail-item">
                        <i class="fas fa-plane-departure"></i>
                        <strong>Origin:</strong>
                        <span class="route-icao">${route.departure}</span>
                    </div>
                    <div class="route-detail-item">
                        <i class="fas fa-plane-arrival"></i>
                        <strong>Destination:</strong>
                        <span class="route-icao">${route.arrival}</span>
                    </div>
                    <div class="route-detail-item">
                        <i class="fas fa-clock"></i>
                        <strong>Flight Time:</strong>
                        <span>${flightTime}</span>
                    </div>
                    <div class="route-detail-item">
                        <i class="fas fa-map-marker-alt"></i>
                        <strong>Waypoints:</strong>
                        <span>${waypointCount}</span>
                    </div>
                </div>
                
                <div class="route-actions">
                    <button class="load-route-btn" onclick="window.loadRouteFromSearch(${route.id})">
                        <i class="fas fa-map-marker-alt"></i> Load on Map
                    </button>
                </div>
            </div>
        `;
    });
    
    console.log('‚úÖ Setting results HTML');
    resultsContainer.innerHTML = html;
}

        function openRouteSearchModal() {
            const modal = document.getElementById('routeSearchModal');
            if (!modal) return;
            
            modal.classList.add('active');
            document.getElementById('searchOrigin').focus();
            
            const resultsContent = document.getElementById('searchResultsContent');
            if (resultsContent) {
                resultsContent.innerHTML = `
                    <div class="no-results">
                        <i class="fas fa-route"></i>
                        <h4>No Search Yet</h4>
                        <p>Enter origin and destination airport codes (IATA or ICAO) to search for saved routes.</p>
                    </div>
                `;
            }
            
            const resultsCount = document.getElementById('resultsCount');
            if (resultsCount) {
                resultsCount.textContent = '0';
            }
        }

        function closeRouteSearchModal() {
            const modal = document.getElementById('routeSearchModal');
            if (modal) {
                modal.classList.remove('active');
            }
        }

        function swapSearchInputs() {
            const originInput = document.getElementById('searchOrigin');
            const destinationInput = document.getElementById('searchDestination');
            
            if (!originInput || !destinationInput) return;
            
            const temp = originInput.value;
            originInput.value = destinationInput.value;
            destinationInput.value = temp;
            
            originInput.value = originInput.value.toUpperCase();
            destinationInput.value = destinationInput.value.toUpperCase();
            
            originInput.focus();
        }

        // Global functions for route loading
        window.loadRouteFromSearch = function(routeId) {
            console.log('Loading route from search:', routeId);
            
            fetch('/api/get-routes/')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        const route = data.routes.find(r => r.id === routeId);
                        if (route) {
                            closeRouteSearchModal();
                            loadRouteOnMap(route);
                            showStatus(`Route "${route.name || 'Unnamed'}" loaded successfully`, 'success');
                        } else {
                            showStatus('Route not found', 'error');
                        }
                    } else {
                        showStatus('Error loading route details', 'error');
                    }
                })
                .catch(error => {
                    console.error('Load route error:', error);
                    showStatus('Error loading route: ' + error, 'error');
                });
        };

        // ==================== VIEW ROUTE DETAILS ====================
        window.viewRouteDetails = function(routeId) {
            console.log('üìã Loading details for route ID:', routeId);
            
            var clickedBtn = event.target.closest('.view-details-btn');
            if (!clickedBtn) return;
            
            var originalHtml = clickedBtn.innerHTML;
            clickedBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
            clickedBtn.disabled = true;
            
            fetch('/api/get-route/' + routeId + '/')
                .then(function(response) {
                    if (!response.ok) {
                        throw new Error('HTTP error: ' + response.status);
                    }
                    return response.json();
                })
                .then(function(data) {
                    clickedBtn.innerHTML = originalHtml;
                    clickedBtn.disabled = false;
                    
                    if (data.status === 'success') {
                        var route = data.route;
                        console.log('‚úÖ Route details loaded:', route);
                        
                        var message = 'üõ´ ROUTE DETAILS (Read-Only)\n' +
                            '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n' +
                            'üìå Route Name: ' + (route.name || 'Unnamed Route') + '\n' +
                            'üìè Total Distance: ' + (route.total_distance || '0') + ' NM\n';
                        
                        var waypointsInfo = 'üìç Waypoints Count: ' + (route.waypoints ? route.waypoints.length : 0) + '\n';
                        
                        if (route.waypoints && route.waypoints.length > 0) {
                            if (route.waypoints.length <= 8) {
                                waypointsInfo += '   ‚îî‚îÄ ' + route.waypoints.join(' ‚Üí ') + '\n';
                            } else {
                                waypointsInfo += '   ‚îî‚îÄ ' + 
                                    route.waypoints.slice(0, 3).join(' ‚Üí ') + 
                                    ' ... ‚Üí ' + 
                                    route.waypoints.slice(-2).join(' ‚Üí ') + '\n';
                            }
                        }
                        
                        message += waypointsInfo;
                        
                        if (route.fir_count > 0) {
                            message += 'üè¢ Flight Info Regions (FIR): ' + route.fir_count + '\n';
                            
                            if (route.fir_list && route.fir_list.length > 0) {
                                message += '   ‚îî‚îÄ Passes through: ';
                                var firNames = route.fir_list.map(function(fir) {
                                    return fir.identifier + ' (' + fir.name + ')';
                                });
                                message += firNames.join(' ‚Üí ') + '\n';
                            }
                        } else {
                            message += 'üè¢ Flight Info Regions (FIR): N/A\n';
                        }
                        
                        message += 
                            '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n' +
                            '‚úàÔ∏è Departure: ' + route.departure + '\n' +
                            '‚úàÔ∏è Arrival: ' + route.arrival + '\n' +
                            '‚è±Ô∏è Flight Time: ' + (route.flight_time || 'N/A') + '\n' +
                            'üìÖ Created: ' + (route.created_at || 'Unknown') + '\n' +
                            'üë§ Created By: ' + (route.created_by || 'System') + '\n';
                        
                        alert(message);
                        
                    } else {
                        alert('‚ùå Error: ' + (data.message || 'Failed to load route details'));
                    }
                })
                .catch(function(error) {
                    clickedBtn.innerHTML = originalHtml;
                    clickedBtn.disabled = false;
                    
                    console.error('‚ùå Detail fetch error:', error);
                    alert('‚ö†Ô∏è Network Error: ' + error.message);
                });
        };

        // ==================== SHOW DIRECT ROUTE FUNCTION ====================
        function showDirectRoute(departure, arrival) {
            console.log('Creating route from', departure, 'to', arrival);
            
            routeLayer.getSource().clear();
            
            fetch('/api/airports/')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to load airport data');
                    }
                    return response.json();
                })
                .then(data => {
                    const depAirport = data.features.find(airport => 
                        airport.properties.iata === departure || 
                        airport.properties.icao === departure
                    );
                    
                    const arrAirport = data.features.find(airport =>
                        airport.properties.iata === arrival || 
                        airport.properties.icao === arrival
                    );
                    
                    if (!depAirport) {
                        showStatus(`Departure airport ${departure} not found`, 'error');
                        return;
                    }
                    
                    if (!arrAirport) {
                        showStatus(`Arrival airport ${arrival} not found`, 'error');
                        return;
                    }
                    
                    const depCoords = ol.proj.fromLonLat(depAirport.geometry.coordinates);
                    const arrCoords = ol.proj.fromLonLat(arrAirport.geometry.coordinates);
                    
                    routeFeature = new ol.Feature({
                        geometry: new ol.geom.LineString([depCoords, arrCoords]),
                        properties: {
                            departure: departure,
                            arrival: arrival,
                            depName: depAirport.properties.name,
                            arrName: arrAirport.properties.name
                        }
                    });
                    
                    routeLayer.getSource().addFeature(routeFeature);
                    routeLayer.setVisible(true);
                    document.getElementById('toggleRoute').checked = true;
                    sessionStorage.setItem('toggleRoute', 'true');
                    
                    updateRouteInfo();
                    document.getElementById('routeInfo').classList.add('active');
                    
                    showStatus(`Route ${departure} ‚Üí ${arrival} created!`, 'success');
                })
                .catch(error => {
                    console.error('Error loading airports:', error);
                    showStatus('Error: Could not load airport data. Using default coordinates.', 'error');
                    
                    const depCoords = ol.proj.fromLonLat([51.3890, 35.6892]);
                    const arrCoords = ol.proj.fromLonLat([59.6400, 36.2350]);
                    
                    routeFeature = new ol.Feature({
                        geometry: new ol.geom.LineString([depCoords, arrCoords]),
                        properties: {
                            departure: departure,
                            arrival: arrival
                        }
                    });
                    
                    routeLayer.getSource().addFeature(routeFeature);
                    routeLayer.setVisible(true);
                    document.getElementById('toggleRoute').checked = true;
                    updateRouteInfo();
                    document.getElementById('routeInfo').classList.add('active');
                });
        }

        function loadRouteOnMap(route) {
            console.log('üîç Loading Route:', route);
            
            routeLayer.getSource().clear();
            
            if (!route.coordinates || !Array.isArray(route.coordinates)) {
                showStatus('Error: Route has no valid coordinates data', 'error');
                return;
            }
            
            let coordinatesData = route.coordinates;
            if (typeof coordinatesData === 'string') {
                try {
                    coordinatesData = JSON.parse(coordinatesData);
                } catch (e) {
                    console.error('Failed to parse coordinates:', e);
                    showStatus('Error: Invalid coordinates format', 'error');
                    return;
                }
            }
            
            if (!Array.isArray(coordinatesData)) {
                showStatus('Error: Coordinates is not an array', 'error');
                return;
            }
            
            const coordinates = coordinatesData.map(coord => {
                if (Array.isArray(coord) && coord.length >= 2) {
                    return ol.proj.fromLonLat([coord[0], coord[1]]);
                }
                return ol.proj.fromLonLat([0, 0]);
            }).filter(coord => coord[0] !== 0 && coord[1] !== 0);
            
            if (coordinates.length < 2) {
                showStatus('Error: Route has insufficient valid coordinates', 'error');
                return;
            }
            
            routeFeature = new ol.Feature({
                geometry: new ol.geom.LineString(coordinates),
                name: route.name || `Route ${route.departure} to ${route.arrival}`,
                departure: route.departure,
                arrival: route.arrival
            });
            
            console.log('‚úÖ Feature created with name:', routeFeature.get('name'));
            
            routeLayer.getSource().addFeature(routeFeature);
            routeLayer.setVisible(true);
            document.getElementById('toggleRoute').checked = true;
            sessionStorage.setItem('toggleRoute', 'true');
            
            updateRouteInfoForSavedRoute(route);
            document.getElementById('routeInfo').classList.add('active');
            
            $('#departureSelect').val(route.departure).trigger('change');
            $('#arrivalSelect').val(route.arrival).trigger('change');
            
            zoomToRoute(coordinates);
        }

        function updateRouteInfo() {
            if (routeFeature) {
                const geometry = routeFeature.getGeometry();
                const coordinates = geometry.getCoordinates();
                
                let totalDistance = 0;
                for (let i = 0; i < coordinates.length - 1; i++) {
                    const coord1 = ol.proj.toLonLat(coordinates[i]);
                    const coord2 = ol.proj.toLonLat(coordinates[i + 1]);
                    totalDistance += calculateDistance(coord1, coord2);
                }
                
                const props = routeFeature.getProperties();
                const depName = props.depName || props.departure;
                const arrName = props.arrName || props.arrival;
                
                document.getElementById('routeDetails').innerHTML = `
                    <div><strong>Route:</strong> ${props.departure} ‚Üí ${props.arrival}</div>
                    <div><strong>From:</strong> ${depName}</div>
                    <div><strong>To:</strong> ${arrName}</div>
                    <div><strong>Total Distance:</strong> ${totalDistance.toFixed(1)} NM</div>
                    <div><strong>Estimated Time:</strong> ${calculateFlightTime(totalDistance)}</div>
                    <div><strong>Waypoints:</strong> 2 (Direct)</div>
                `;
            }
        }

        function updateRouteInfoForSavedRoute(route) {
            const distance = route.total_distance ? route.total_distance.toFixed(1) : 'N/A';
            const flightTime = route.flight_time || 'N/A';
            const waypointCount = route.waypoints ? route.waypoints.length : 0;
            
            document.getElementById('routeDetails').innerHTML = `
                <div><strong>Route:</strong> ${route.name || `Route ${route.departure} ‚Üí ${route.arrival}`}</div>
                <div><strong>From:</strong> ${route.departure}</div>
                <div><strong>To:</strong> ${route.arrival}</div>
                <div><strong>Total Distance:</strong> ${distance} NM</div>
                <div><strong>Flight Time:</strong> ${flightTime}</div>
                <div><strong>Waypoints:</strong> ${waypointCount}</div>
                <div><strong>Saved:</strong> ${route.created_at ? new Date(route.created_at).toLocaleDateString() : 'Unknown'}</div>
            `;
        }

        function zoomToRoute(coordinates) {
            if (coordinates.length > 0) {
                const extent = new ol.geom.LineString(coordinates).getExtent();
                map.getView().fit(extent, {
                    padding: [50, 50, 50, 50],
                    duration: 1000,
                    maxZoom: 10
                });
            }
        }

        // ==================== MAP CONTROLS ====================
        document.getElementById('zoomIn').addEventListener('click', function() {
            const view = map.getView();
            view.animate({
                zoom: view.getZoom() + 1,
                duration: 250
            });
        });

        document.getElementById('zoomOut').addEventListener('click', function() {
            const view = map.getView();
            view.animate({
                zoom: view.getZoom() - 1,
                duration: 250
            });
        });

        document.getElementById('resetView').addEventListener('click', function() {
            map.getView().animate({
                center: ol.proj.fromLonLat([51.3890, 35.6892]),
                zoom: 5,
                duration: 500
            });
        });

        // ==================== TOOLTIP HANDLING ====================
        map.on('pointermove', function(event) {
            const pixel = map.getEventPixel(event.originalEvent);
            
            firTooltipOverlay.setPosition(undefined);
            wpTooltipOverlay.setPosition(undefined);
            if (window.routeTooltipOverlay) {
                window.routeTooltipOverlay.setPosition(undefined);
            }
            
            if (map && map.getTarget() && map.getTarget().style) {
                map.getTarget().style.cursor = '';
            }
            
            let feature = map.forEachFeatureAtPixel(pixel, function(feature, layer) {
                if (layer === firLayer) {
                    return feature;
                }
                return null;
            });
            
            if (feature) {
                const props = feature.getProperties();
                const tooltipText = `
                    <div style="text-align: left; max-width: 250px;">
                        <strong style="font-size: 14px;">FIR: ${props.identifier || 'N/A'}</strong><br>
                        <span style="color: #ffcc00;">${props.name || 'N/A'}</span>
                        <hr style="margin: 8px 0; border-color: rgba(255,255,255,0.3)">
                        <div style="font-size: 12px; line-height: 1.4;">
                            <div><strong>Country:</strong> ${props.country || 'N/A'}</div>
                            <div><strong>Frequency:</strong> ${props.frequency || 'N/A'}</div>
                            <div><strong>Altitude:</strong> ${props.lower_limit || '0'}-${props.upper_limit || '99999'} ft</div>
                            <div><strong>ICAO Region:</strong> ${props.icao_region || 'N/A'}</div>
                            <div><strong>Area:</strong> ${props.area_km2 ? props.area_km2.toLocaleString() + ' km¬≤' : 'N/A'}</div>
                        </div>
                    </div>
                    <div class="tooltip-arrow"></div>
                `;
                
                firTooltipElement.innerHTML = tooltipText;
                firTooltipOverlay.setPosition(event.coordinate);
                
                if (map && map.getTarget() && map.getTarget().style) {
                    map.getTarget().style.cursor = 'pointer';
                }
                return;
            }
            
            feature = map.forEachFeatureAtPixel(pixel, function(feature, layer) {
                if (layer === waypointLayer || layer === airportLayer) {
                    return feature;
                }
                return null;
            });
            
            if (feature) {
                const props = feature.getProperties();
                let tooltipText = '';
                
                if (props.iata) {
                    const airportName = props.name || props.identifier || 'Airport';
                    const displayName = airportName.length > 30 
                        ? airportName.substring(0, 27) + '...' 
                        : airportName;
                    
                    tooltipText = `
                        <div style="text-align: left; max-width: 250px;">
                            <div style="
                                display: flex;
                                align-items: center;
                                gap: 8px;
                                margin-bottom: 8px;
                            ">
                                <div style="
                                    width: 24px;
                                    height: 24px;
                                    background: #1a73e8;
                                    border-radius: 50%;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    color: white;
                                    font-size: 12px;
                                    flex-shrink: 0;
                                ">‚úà</div>
                                <div style="
                                    font-size: 14px;
                                    color: #1a73e8;
                                    font-weight: bold;
                                    overflow: hidden;
                                    text-overflow: ellipsis;
                                    white-space: nowrap;
                                    max-width: 200px;
                                " title="${airportName}">
                                    ${displayName}
                                </div>
                            </div>
                            <hr style="margin: 8px 0; border-color: rgba(255,255,255,0.3)">
                            <div style="font-size: 12px; line-height: 1.4;">
                                <div><strong style="color: #4fc3f7;">IATA:</strong> ${props.iata || 'N/A'}</div>
                                <div><strong style="color: #4fc3f7;">ICAO:</strong> ${props.icao || 'N/A'}</div>
                                <div><strong style="color: #4fc3f7;">City:</strong> ${props.city || 'N/A'}</div>
                                <div><strong style="color: #4fc3f7;">Country:</strong> ${props.country || 'N/A'}</div>
                            </div>
                            <div class="tooltip-arrow"></div>
                        </div>
                    `;
                } else if (props.identifier) {
                    const type = props.type || 'WAYPOINT';
                    const frequency = props.frequency ? `${props.frequency} MHz` : 'N/A';
                    const elevation = props.elevation ? `${props.elevation} ft` : 'N/A';
                    
                    let typeIcon = '';
                    switch(type.toUpperCase()) {
                        case 'VOR': typeIcon = 'üéØ VOR/DME'; break;
                        case 'NDB': typeIcon = 'üìª NDB'; break;
                        case 'AIRPORT': typeIcon = '‚úà AIRPORT'; break;
                        case 'FIX': typeIcon = 'üìç FIX'; break;
                        default: typeIcon = 'üìç ' + type;
                    }
                    
                    tooltipText = `
                        <div style="text-align: left;">
                            <strong style="font-size: 14px; color: #FF6B35;">${typeIcon}</strong><br>
                            <strong>${props.identifier}</strong> - ${props.name || 'Unnamed Waypoint'}<br>
                            <hr style="margin: 5px 0; border-color: rgba(255,255,255,0.3)">
                            <strong>Type:</strong> ${type}<br>
                            ${frequency !== 'N/A' ? `<strong>Frequency:</strong> ${frequency}<br>` : ''}
                            ${elevation !== 'N/A' ? `<strong>Elevation:</strong> ${elevation}<br>` : ''}
                            <strong>Country:</strong> ${props.country || 'N/A'}<br>
                            ${props.magnetic_variation ? `<strong>Magnetic Var:</strong> ${props.magnetic_variation}¬∞<br>` : ''}
                        </div>
                        <div class="tooltip-arrow"></div>
                    `;
                }
                
                if (tooltipText) {
                    wpTooltipElement.innerHTML = tooltipText;
                    wpTooltipOverlay.setPosition(event.coordinate);
                    
                    if (map && map.getTarget() && map.getTarget().style) {
                        map.getTarget().style.cursor = 'pointer';
                    }
                }
                return;
            }
            
            // ========== HOVER ON ROUTE ==========
            feature = map.forEachFeatureAtPixel(pixel, function(feature, layer) {
                if (layer === routeLayer) {
                    return feature;
                }
                return null;
            });
            
            if (feature) {
                if (!window.routeTooltipElement) {
                    window.routeTooltipElement = document.createElement('div');
                    window.routeTooltipElement.className = 'route-tooltip';
                    window.routeTooltipOverlay = new ol.Overlay({
                        element: window.routeTooltipElement,
                        positioning: 'bottom-center',
                        offset: [0, -10],
                        stopEvent: false
                    });
                    map.addOverlay(window.routeTooltipOverlay);
                }
                
                const props = feature.getProperties();
                const geometry = feature.getGeometry();
                
                let totalDistance = 0;
                if (geometry && geometry.getType() === 'LineString') {
                    const coordinates = geometry.getCoordinates();
                    for (let i = 0; i < coordinates.length - 1; i++) {
                        const coord1 = ol.proj.toLonLat(coordinates[i]);
                        const coord2 = ol.proj.toLonLat(coordinates[i + 1]);
                        totalDistance += calculateDistance(coord1, coord2);
                    }
                }
                
                const routeName = props.name || `${props.departure || ''} to ${props.arrival || ''}`;
                
                const tooltipHTML = `
                    <div class="route-tooltip-content">
                        <div class="route-tooltip-header">
                            <div class="route-icon">‚úà</div>
                            <div class="route-title">FLIGHT ROUTE</div>
                        </div>
                        <div class="tooltip-row">
                            <span class="tooltip-label">
                                <i class="fas fa-route"></i>
                                Route Name:
                            </span>
                            <span class="tooltip-value name" title="${routeName}">${routeName}</span>
                        </div>
                        <div class="tooltip-row">
                            <span class="tooltip-label">
                                <i class="fas fa-ruler"></i>
                                Distance:
                            </span>
                            <span class="tooltip-value distance">${totalDistance.toFixed(1)} NM</span>
                        </div>
                    </div>
                    <div class="tooltip-arrow"></div>
                `;
                window.routeTooltipElement.innerHTML = tooltipHTML;
                window.routeTooltipOverlay.setPosition(event.coordinate);
                
                if (map && map.getTarget() && map.getTarget().style) {
                    map.getTarget().style.cursor = 'pointer';
                }
                return;
            }
        });

        // ==================== POINTER LEAVE ====================
        map.on('pointerleave', function() {
            firTooltipOverlay.setPosition(undefined);
            wpTooltipOverlay.setPosition(undefined);
            if (window.routeTooltipOverlay) {
                window.routeTooltipOverlay.setPosition(undefined);
            }
        });

        // ==================== TOOL SELECTION ====================
        function removeAllInteractions() {
            if (drawInteraction) {
                map.removeInteraction(drawInteraction);
                drawInteraction = null;
            }
            if (measureInteraction) {
                map.removeInteraction(measureInteraction);
                measureInteraction = null;
            }
            if (modifyInteraction) {
                map.removeInteraction(modifyInteraction);
                modifyInteraction = null;
            }
            if (snapInteraction) {
                map.removeInteraction(snapInteraction);
                snapInteraction = null;
            }
        }

        function activateTool(toolName) {
            removeAllInteractions();
            currentTool = toolName;
            
            document.querySelectorAll('.control-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            const mapElement = document.getElementById('map');
            mapElement.classList.remove('cursor-crosshair', 'cursor-grab', 'cursor-grabbing');
            
            map.getInteractions().forEach(interaction => {
                if (interaction instanceof ol.interaction.DragPan) {
                    interaction.setActive(toolName === 'pan');
                }
            });
            
            if (toolName === 'pan') {
                document.getElementById('panTool').classList.add('active');
                mapElement.classList.add('cursor-grab');
                
                mapElement.addEventListener('mousedown', function() {
                    mapElement.classList.add('cursor-grabbing');
                });
                mapElement.addEventListener('mouseup', function() {
                    mapElement.classList.remove('cursor-grabbing');
                });
                
                showStatus('Pan tool activated - Drag to move map', 'info');
                
            } else if (toolName === 'select') {
                document.getElementById('selectTool').classList.add('active');
                
            } else if (toolName === 'measure') {
                activateMeasureTool();
                document.getElementById('measureTool').classList.add('active');
                mapElement.classList.add('cursor-crosshair');
            }
        }

        document.getElementById('panTool').addEventListener('click', function() {
            activateTool('pan');
        });

        document.getElementById('selectTool').addEventListener('click', function() {
            activateTool('select');
        });

        document.getElementById('measureTool').addEventListener('click', function() {
            activateTool('measure');
        });

        function activateMeasureTool() {
            console.log('Activating measure tool...');
            
            removeAllInteractions();
            
            const source = new ol.source.Vector();
            const measureLayer = new ol.layer.Vector({
                source: source,
                style: function(feature) {
                    const distance = feature.get('distance');
                    const styles = [
                        new ol.style.Style({
                            stroke: new ol.style.Stroke({
                                color: '#ff0000',
                                width: 3,
                                lineDash: [5, 5]
                            })
                        }),
                        new ol.style.Style({
                            image: new ol.style.Circle({
                                radius: 6,
                                fill: new ol.style.Fill({
                                    color: '#ff0000'
                                }),
                                stroke: new ol.style.Stroke({
                                    color: 'white',
                                    width: 2
                                })
                            })
                        })
                    ];
                    
                    if (distance) {
                        const geometry = feature.getGeometry();
                        const coordinates = geometry.getCoordinates();
                        
                        if (coordinates.length > 1) {
                            const midIndex = Math.floor(coordinates.length / 2);
                            const midPoint = coordinates[midIndex];
                            
                            styles.push(new ol.style.Style({
                                text: new ol.style.Text({
                                    text: distance.toFixed(1) + ' NM',
                                    font: 'bold 14px Arial',
                                    fill: new ol.style.Fill({
                                        color: '#ff0000'
                                    }),
                                    stroke: new ol.style.Stroke({
                                        color: 'white',
                                        width: 3
                                    }),
                                    backgroundFill: new ol.style.Fill({
                                        color: 'rgba(255, 255, 255, 0.8)'
                                    }),
                                    padding: [4, 6, 4, 6],
                                    offsetY: -15
                                }),
                                geometry: new ol.geom.Point(midPoint)
                            }));
                        }
                    }
                    
                    return styles;
                }
            });
            
            map.addLayer(measureLayer);
            
            drawInteraction = new ol.interaction.Draw({
                source: source,
                type: 'LineString',
                style: new ol.style.Style({
                    stroke: new ol.style.Stroke({
                        color: 'rgba(255, 0, 0, 0.7)',
                        width: 2,
                        lineDash: [5, 5]
                    }),
                    image: new ol.style.Circle({
                        radius: 5,
                        fill: new ol.style.Fill({
                            color: 'rgba(255, 0, 0, 0.7)'
                        })
                    })
                })
            });
            
            map.addInteraction(drawInteraction);
            
            let totalDistance = 0;
            
            drawInteraction.on('drawstart', function() {
                totalDistance = 0;
                console.log('Start measuring...');
            });
            
            drawInteraction.on('drawend', function(evt) {
                const feature = evt.feature;
                const geometry = feature.getGeometry();
                const coordinates = geometry.getCoordinates();
                
                totalDistance = 0;
                for (let i = 0; i < coordinates.length - 1; i++) {
                    const coord1 = ol.proj.toLonLat(coordinates[i]);
                    const coord2 = ol.proj.toLonLat(coordinates[i + 1]);
                    totalDistance += calculateDistance(coord1, coord2);
                }
                
                feature.set('distance', totalDistance);
                measureLayer.changed();
                
                showStatus(`Measured distance: ${totalDistance.toFixed(1)} NM`, 'success');
                
                setTimeout(function() {
                    if (measureLayer) {
                        map.removeLayer(measureLayer);
                    }
                    activateTool('select');
                }, 4000);
            });
            
            document.getElementById('map').classList.add('cursor-crosshair');
        }

        // ==================== EVENT LISTENERS ====================
        document.getElementById('viewMode').addEventListener('click', function() {
            currentMode = 'view';
            updateModeUI();
            
            // ÿß⁄Øÿ± ÿØÿ± ÿ≠ÿßŸÑ Ÿà€åÿ±ÿß€åÿ¥ ÿ®ŸàÿØ€åŸÖÿå ÿ∫€åÿ±ŸÅÿπÿßŸÑÿ¥ ⁄©ŸÜ
            if (isEditingEnabled) {
                toggleEditing();
            }
            
            showStatus('View mode activated', 'info');
        });

        document.getElementById('editMode').addEventListener('click', function() {
            currentMode = 'edit';
            updateModeUI();
            
            // ÿß⁄Øÿ± ÿ±Ÿàÿ™€å Ÿàÿ¨ŸàÿØ ÿØÿßÿ±ÿØÿå Ÿà€åÿ±ÿß€åÿ¥ ÿ±ÿß Ÿæ€åÿ¥ŸÜŸáÿßÿØ ⁄©ŸÜ
            const routeFeatures = routeLayer.getSource().getFeatures();
            if (routeFeatures.length > 0 && !isEditingEnabled) {
                showStatus('Edit Mode ‚úì Now click "Enable Editing" to modify route', 'info');
            }
            
            showStatus('Edit mode activated', 'success');
        });

        // ==================== EDIT TOOLS EVENT LISTENERS ====================
        document.getElementById('btnToggleEdit').addEventListener('click', toggleEditing);
        document.getElementById('btnSave').addEventListener('click', function() {
            saveCurrentRoute(false);
        });
        document.getElementById('btnSaveAs').addEventListener('click', function() {
            saveCurrentRoute(true);
        });

        document.getElementById('showDirectRoute').addEventListener('click', function() {
            const departure = $('#departureSelect').val();
            const arrival = $('#arrivalSelect').val();
            
            if (departure && arrival) {
                showDirectRoute(departure, arrival);
            } else {
                showStatus('Please select both departure and arrival airports', 'error');
            }
        });

        document.getElementById('clearRoute').addEventListener('click', function() {
            routeLayer.getSource().clear();
            routeFeature = null;
            routeLayer.setVisible(false);
            document.getElementById('toggleRoute').checked = false;
            sessionStorage.setItem('toggleRoute', 'false');
            
            document.getElementById('routeInfo').classList.remove('active');
            
            if (isEditingEnabled) {
                toggleEditing();
            }
            
            showStatus('Route cleared', 'info');
        });

        // ==================== ROUTE SEARCH EVENT LISTENERS ====================
        document.getElementById('routeSearchBtn').addEventListener('click', openRouteSearchModal);
        document.getElementById('closeRouteSearchModal').addEventListener('click', closeRouteSearchModal);
        document.getElementById('swapSearchInputs').addEventListener('click', swapSearchInputs);
        document.getElementById('executeRouteSearch').addEventListener('click', executeRouteSearch);

        document.getElementById('searchOrigin').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                executeRouteSearch();
            }
        });

        document.getElementById('searchDestination').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                executeRouteSearch();
            }
        });

        document.getElementById('routeSearchModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeRouteSearchModal();
            }
        });

// ==================== SAVE MODAL EVENT LISTENERS ====================
document.getElementById('closeSaveModal').addEventListener('click', closeSaveRouteModal);
document.getElementById('cancelSaveBtn').addEventListener('click', closeSaveRouteModal);

// Confirm button in save modal
document.getElementById('confirmSaveBtn').addEventListener('click', function() {
    console.log('üñ±Ô∏è Confirm Save button clicked');
    console.log('üîç currentRouteToSave status:', currentRouteToSave ? 'Exists' : 'NULL');
    
    // Check if route data is prepared
    if (!currentRouteToSave) {
        showStatus('‚ùå Route data not prepared. Please create route and click Save button first.', 'error');
        return;
    }
    
    executeSaveWithName();
});

// Allow Enter key to save
document.getElementById('routeNameInput').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        if (!currentRouteToSave) {
            showStatus('‚ùå Route not ready for saving', 'error');
            return;
        }
        executeSaveWithName();
    }
});

// Close modal when clicking outside
document.getElementById('saveRouteModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeSaveRouteModal();
    }
});

        // ==================== LAYER CONTROLS ====================
        function initLayerControls() {
            const layerMap = {
                'toggleAirports': airportLayer,
                'toggleWaypoints': waypointLayer,
                'toggleFIR': firLayer,
                'toggleRoute': routeLayer
            };

            Object.keys(layerMap).forEach(checkboxId => {
                const checkbox = document.getElementById(checkboxId);
                const layer = layerMap[checkboxId];
                
                const savedState = sessionStorage.getItem(checkboxId);
                
                if (savedState !== null) {
                    const isVisible = savedState === 'true';
                    checkbox.checked = isVisible;
                    layer.setVisible(isVisible);
                } else {
                    checkbox.checked = false;
                    layer.setVisible(false);
                    sessionStorage.setItem(checkboxId, 'false');
                }

                checkbox.addEventListener('change', function() {
                    const isChecked = this.checked;
                    layer.setVisible(isChecked);
                    sessionStorage.setItem(checkboxId, isChecked.toString());
                });
            });
        }

        // ==================== RESIZABLE SIDEBAR ====================
        document.addEventListener('DOMContentLoaded', function() {
            const sidebar = document.getElementById('sidebar');
            const resizeHandle = document.getElementById('resizeHandle');
            
            const collapseBtn = document.createElement('div');
            collapseBtn.className = 'collapse-btn';
            collapseBtn.innerHTML = '<i class="fas fa-chevron-left"></i>';
            sidebar.appendChild(collapseBtn);
            
            let isResizing = false;
            let startX, startWidth;
            
            function initResize(e) {
                isResizing = true;
                startX = e.clientX;
                startWidth = parseInt(document.defaultView.getComputedStyle(sidebar).width, 10);
                sidebar.classList.add('resizing');
                resizeHandle.classList.add('resizing');
                
                document.addEventListener('mousemove', resize);
                document.addEventListener('mouseup', stopResize);
            }
            
            function resize(e) {
                if (!isResizing) return;
                
                const width = startWidth + e.clientX - startX;
                const minWidth = 250;
                const maxWidth = 500;
                
                if (width >= minWidth && width <= maxWidth) {
                    sidebar.style.width = width + 'px';
                }
            }
            
            function stopResize() {
                isResizing = false;
                sidebar.classList.remove('resizing');
                resizeHandle.classList.remove('resizing');
                
                document.removeEventListener('mousemove', resize);
                document.removeEventListener('mouseup', stopResize);
                
                localStorage.setItem('sidebarWidth', sidebar.style.width);
                
                setTimeout(() => {
                    map.updateSize();
                }, 100);
            }
            
            collapseBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                
                if (sidebar.classList.contains('collapsed')) {
                    sidebar.classList.remove('collapsed');
                    sidebar.style.width = localStorage.getItem('sidebarWidth') || '320px';
                    collapseBtn.innerHTML = '<i class="fas fa-chevron-left"></i>';
                    localStorage.setItem('sidebarCollapsed', 'false');
                } else {
                    sidebar.classList.add('collapsed');
                    localStorage.setItem('sidebarWidth', sidebar.style.width);
                    sidebar.style.width = '50px';
                    collapseBtn.innerHTML = '<i class="fas fa-chevron-right"></i>';
                    localStorage.setItem('sidebarCollapsed', 'true');
                }
                
                setTimeout(() => {
                    map.updateSize();
                }, 300);
            });
            
            resizeHandle.addEventListener('mousedown', initResize);
            
            const savedWidth = localStorage.getItem('sidebarWidth');
            const isCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
            
            if (savedWidth && !isCollapsed) {
                sidebar.style.width = savedWidth;
            }
            
            if (isCollapsed) {
                sidebar.classList.add('collapsed');
                sidebar.style.width = '50px';
                collapseBtn.innerHTML = '<i class="fas fa-chevron-right"></i>';
            }
            
            resizeHandle.addEventListener('dblclick', function() {
                collapseBtn.click();
            });
            
            resizeHandle.addEventListener('touchstart', function(e) {
                e.preventDefault();
                initResize(e.touches[0]);
            });
            
            document.addEventListener('touchmove', function(e) {
                if (isResizing) {
                    resize(e.touches[0]);
                }
            });
            
            document.addEventListener('touchend', stopResize);
        });

        // ==================== INITIALIZATION ====================
        fetch('/api/airports/')
            .then(response => response.json())
            .then(data => {
                const departureSelect = document.getElementById('departureSelect');
                const arrivalSelect = document.getElementById('arrivalSelect');
                
                data.features.forEach(airport => {
                    const option = document.createElement('option');
                    option.value = airport.properties.iata;
                    option.textContent = `${airport.properties.name} (${airport.properties.iata}/${airport.properties.icao}) - ${airport.properties.city}`;
                    
                    departureSelect.appendChild(option.cloneNode(true));
                    arrivalSelect.appendChild(option);
                });

                $('.airport-select').select2({
                    placeholder: "Search by name, IATA, ICAO or city",
                    width: '100%',
                    dropdownParent: $('.sidebar')
                });
                
                console.log('‚úÖ Airports loaded:', data.features.length);
            })
            .catch(error => {
                console.error('‚ùå Error loading airports:', error);
                showStatus('Error loading airports data', 'error');
            });
// ==================== SIMPLE GLOBAL SEARCH ====================
document.getElementById('searchButton').addEventListener('click', performSimpleSearch);
document.getElementById('globalSearch').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') performSimpleSearch();
});

async function performSimpleSearch() {
    const searchTerm = document.getElementById('globalSearch').value.trim().toUpperCase();
    
    if (!searchTerm) {
        showStatus('‚ùå Please enter search term', 'error');
        return;
    }
    
    console.log('üîç Searching for:', searchTerm);
    showStatus(`Searching for "${searchTerm}"...`, 'info');
    
    // Reset all highlights
    resetAllHighlights();
    
    try {
        let foundItems = [];
        let activatedLayer = null;
        
        // ÿ™ÿ±ÿ™€åÿ® ÿßŸàŸÑŸà€åÿ™ ÿ¨ÿ≥ÿ™ÿ¨Ÿà
        // 1. ÿßŸàŸÑ ŸÅÿ±ŸàÿØ⁄ØÿßŸá‚ÄåŸáÿß
        const airportResults = searchInAirports(searchTerm);
        if (airportResults.length > 0) {
            foundItems = airportResults;
            activatedLayer = 'airports';
        }
        
        // 2. ÿß⁄Øÿ± ŸÅÿ±ŸàÿØ⁄ØÿßŸá Ÿæ€åÿØÿß ŸÜÿ¥ÿØÿå waypoints
        else {
            const waypointResults = searchInWaypoints(searchTerm);
            if (waypointResults.length > 0) {
                foundItems = waypointResults;
                activatedLayer = 'waypoints';
            }
            
            // 3. ÿß⁄Øÿ± waypoint ŸáŸÖ Ÿæ€åÿØÿß ŸÜÿ¥ÿØÿå FIRŸáÿß
            else {
                const firResults = searchInFIRs(searchTerm);
                if (firResults.length > 0) {
                    foundItems = firResults;
                    activatedLayer = 'firs';
                }
            }
        }
        
        // ŸÜŸÖÿß€åÿ¥ ŸÜÿ™ÿß€åÿ¨
        if (foundItems.length > 0) {
            displaySearchResults(foundItems, searchTerm);
            
            // ŸÅŸÇÿ∑ ŸÑÿß€åŸá ŸÖÿ±ÿ®Ÿàÿ∑Ÿá ÿ±ÿß ÿ±Ÿàÿ¥ŸÜ ⁄©ŸÜÿå ÿ®ŸÇ€åŸá ÿ±ÿß ÿÆÿßŸÖŸàÿ¥ ⁄©ŸÜ
            setOnlyLayerActive(activatedLayer);
            
        } else {
            showStatus(`‚ùå No results found for "${searchTerm}"`, 'error');
        }
        
    } catch (error) {
        console.error('Search error:', error);
        showStatus('‚ùå Search error occurred', 'error');
    }
}

// ŸÅŸÇÿ∑ €å⁄© ŸÑÿß€åŸá ÿ±ÿß ŸÅÿπÿßŸÑ ⁄©ŸÜÿå ÿ®ŸÇ€åŸá ÿ±ÿß ÿ∫€åÿ±ŸÅÿπÿßŸÑ
function setOnlyLayerActive(layerName) {
    // ŸáŸÖŸá ŸÑÿß€åŸá‚ÄåŸáÿß ÿ±ÿß ÿßŸàŸÑ ÿÆÿßŸÖŸàÿ¥ ⁄©ŸÜ
    airportLayer.setVisible(false);
    waypointLayer.setVisible(false);
    firLayer.setVisible(false);
    
    document.getElementById('toggleAirports').checked = false;
    document.getElementById('toggleWaypoints').checked = false;
    document.getElementById('toggleFIR').checked = false;
    
    sessionStorage.setItem('toggleAirports', 'false');
    sessionStorage.setItem('toggleWaypoints', 'false');
    sessionStorage.setItem('toggleFIR', 'false');
    
    // ÿ≠ÿßŸÑÿß ŸÅŸÇÿ∑ ŸÑÿß€åŸá ŸÖŸàÿ±ÿØ ŸÜÿ∏ÿ± ÿ±ÿß ÿ±Ÿàÿ¥ŸÜ ⁄©ŸÜ
    if (layerName === 'airports') {
        airportLayer.setVisible(true);
        document.getElementById('toggleAirports').checked = true;
        sessionStorage.setItem('toggleAirports', 'true');
        showStatus('Showing Airports only', 'info');
    }
    else if (layerName === 'waypoints') {
        waypointLayer.setVisible(true);
        document.getElementById('toggleWaypoints').checked = true;
        sessionStorage.setItem('toggleWaypoints', 'true');
        showStatus('Showing Waypoints only', 'info');
    }
    else if (layerName === 'firs') {
        firLayer.setVisible(true);
        document.getElementById('toggleFIR').checked = true;
        sessionStorage.setItem('toggleFIR', 'true');
        showStatus('Showing FIR Regions only', 'info');
    }
}

// ÿ™Ÿàÿßÿ®ÿπ ÿ¨ÿ≥ÿ™ÿ¨Ÿà (ÿ®ÿØŸàŸÜ ÿ™ÿ∫€å€åÿ± ÿØÿ± ÿ®ÿÆÿ¥ ÿ±Ÿàÿ¥ŸÜ ⁄©ÿ±ÿØŸÜ ŸÑÿß€åŸá)
function searchInAirports(searchTerm) {
    const results = [];
    const source = airportLayer.getSource();
    const features = source.getFeatures();
    
    for (const feature of features) {
        const props = feature.getProperties();
        const name = props.name || '';
        const iata = props.iata || '';
        const icao = props.icao || '';
        const identifier = props.identifier || '';
        const city = props.city || '';
        const country = props.country || '';
        
        if (iata === searchTerm || 
            icao === searchTerm || 
            identifier === searchTerm ||
            name.toUpperCase().includes(searchTerm) ||
            city.toUpperCase().includes(searchTerm) ||
            country.toUpperCase().includes(searchTerm)) {
            
            highlightFeature(feature, airportLayer, '#1a73e8');
            
            results.push({
                type: 'airport',
                feature: feature,
                properties: props,
                coordinates: feature.getGeometry().getCoordinates()
            });
            
            if (iata === searchTerm || icao === searchTerm || identifier === searchTerm) {
                break;
            }
        }
    }
    
    return results;
}

function searchInWaypoints(searchTerm) {
    const results = [];
    const source = waypointLayer.getSource();
    const features = source.getFeatures();
    
    for (const feature of features) {
        const props = feature.getProperties();
        const identifier = props.identifier || '';
        const name = props.name || '';
        const type = props.type || '';
        const country = props.country || '';
        
        if (identifier === searchTerm || 
            name.toUpperCase().includes(searchTerm) ||
            (type && type.toUpperCase().includes(searchTerm))) {
            
            highlightFeature(feature, waypointLayer, '#FF6B35');
            
            results.push({
                type: 'waypoint',
                feature: feature,
                properties: props,
                coordinates: feature.getGeometry().getCoordinates()
            });
            
            if (identifier === searchTerm) {
                break;
            }
        }
    }
    
    return results;
}

function searchInFIRs(searchTerm) {
    const results = [];
    const source = firLayer.getSource();
    const features = source.getFeatures();
    
    for (const feature of features) {
        const props = feature.getProperties();
        const identifier = props.identifier || '';
        const name = props.name || '';
        const country = props.country || '';
        const icaoRegion = props.icao_region || '';
        
        if (identifier === searchTerm || 
            name.toUpperCase().includes(searchTerm) ||
            country.toUpperCase().includes(searchTerm) ||
            icaoRegion === searchTerm) {
            
            highlightFeature(feature, firLayer, '#ea4335');
            
            results.push({
                type: 'fir',
                feature: feature,
                properties: props,
                coordinates: feature.getGeometry().getExtent()
            });
            
            if (identifier === searchTerm) {
                break;
            }
        }
    }
    
    return results;
}

function highlightFeature(feature, layer, color) {
    const originalStyle = layer.getStyle();
    
    layer.setStyle(function(layerFeature) {
        if (layerFeature === feature) {
            // Highlight style
            if (layer === firLayer) {
                return new ol.style.Style({
                    stroke: new ol.style.Stroke({
                        color: '#ff0000',
                        width: 4,
                        lineDash: [5, 5]
                    }),
                    fill: new ol.style.Fill({
                        color: 'rgba(255, 0, 0, 0.2)'
                    }),
                    text: new ol.style.Text({
                        text: feature.get('identifier') || 'FIR',
                        fill: new ol.style.Fill({color: '#ff0000'}),
                        stroke: new ol.style.Stroke({color: 'white', width: 3}),
                        offsetY: -20,
                        font: 'bold 14px Arial'
                    })
                });
            } else {
                return new ol.style.Style({
                    image: new ol.style.Circle({
                        radius: layer === airportLayer ? 10 : 8,
                        fill: new ol.style.Fill({color: '#ff0000'}),
                        stroke: new ol.style.Stroke({
                            color: 'white',
                            width: 3
                        })
                    }),
                    text: layer === airportLayer ? new ol.style.Text({
                        text: feature.get('iata') || feature.get('icao') || 'AIRPORT',
                        offsetY: -15,
                        fill: new ol.style.Fill({color: '#ff0000'}),
                        stroke: new ol.style.Stroke({color: 'white', width: 3}),
                        font: 'bold 12px Arial'
                    }) : undefined
                });
            }
        }
        
        // Return original style for other features
        if (typeof originalStyle === 'function') {
            return originalStyle(layerFeature);
        }
        return originalStyle;
    });
    
    // Auto-remove highlight after 10 seconds
    setTimeout(() => {
        layer.setStyle(originalStyle);
    }, 10000);
}

function resetAllHighlights() {
    // Reset airport layer
    airportLayer.setStyle(new ol.style.Style({
        image: new ol.style.Circle({
            radius: 6,
            fill: new ol.style.Fill({color: '#1a73e8'}),
            stroke: new ol.style.Stroke({color: 'white', width: 2})
        })
    }));
    
    // Reset waypoint layer
    waypointLayer.setStyle(function(feature) {
        const type = feature.get('type');
        let color, icon;
        
        switch(type) {
            case 'VOR': color = '#FF6B35'; icon = 'V'; break;
            case 'NDB': color = '#34a853'; icon = 'N'; break;
            case 'AIRPORT': color = '#1a73e8'; icon = 'A'; break;
            default: color = '#5f6368'; icon = 'W';
        }
        
        return new ol.style.Style({
            image: new ol.style.Circle({
                radius: 5,
                fill: new ol.style.Fill({color: color}),
                stroke: new ol.style.Stroke({color: 'white', width: 1.5})
            }),
            text: new ol.style.Text({
                text: feature.get('identifier') + ' ' + icon,
                offsetY: -10,
                fill: new ol.style.Fill({color: color}),
                stroke: new ol.style.Stroke({color: 'white', width: 2}),
                font: 'bold 11px Arial'
            })
        });
    });
    
    // Reset FIR layer
    firLayer.setStyle(function(feature) {
        const identifier = feature.get('identifier');
        
        return new ol.style.Style({
            stroke: new ol.style.Stroke({
                color: 'rgba(234, 67, 53, 0.7)',
                width: 2,
                lineDash: [5, 5]
            }),
            fill: new ol.style.Fill({
                color: 'rgba(234, 67, 53, 0.1)'
            }),
            text: new ol.style.Text({
                text: identifier,
                fill: new ol.style.Fill({color: '#ea4335'}),
                stroke: new ol.style.Stroke({color: 'white', width: 2}),
                offsetY: -20,
                font: 'bold 12px Arial',
                overflow: true
            })
        });
    });
}

function displaySearchResults(results, searchTerm) {
    if (results.length === 1) {
        // Single result - zoom to it
        const result = results[0];
        zoomToResult(result);
        
        // Show status
        const name = result.properties.name || 
                    result.properties.identifier || 
                    result.properties.iata || 
                    'Location';
        showStatus(`‚úÖ Found: ${name}`, 'success');
        
    } else {
        // Multiple results - show simple popup
        showResultsPopup(results, searchTerm);
    }
}

function zoomToResult(result) {
    if (!result || !result.coordinates) return;
    
    if (result.type === 'fir') {
        // Zoom to FIR extent
        map.getView().fit(result.coordinates, {
            padding: [50, 50, 50, 50],
            duration: 1000,
            maxZoom: 8
        });
    } else {
        // Zoom to point
        map.getView().animate({
            center: result.coordinates,
            zoom: result.type === 'airport' ? 12 : 10,
            duration: 1000
        });
    }
}

function showResultsPopup(results, searchTerm) {
    // Create a simple popup
    const popup = document.createElement('div');
    popup.className = 'search-results-popup';
    popup.innerHTML = `
        <div class="popup-header">
            <h4><i class="fas fa-search"></i> ${results.length} results for "${searchTerm}"</h4>
            <button class="close-popup">&times;</button>
        </div>
        <div class="popup-body">
            ${results.map((result, index) => `
                <div class="result-item" data-index="${index}">
                    <div class="result-type ${result.type}">
                        <i class="fas ${getIconForType(result.type)}"></i>
                    </div>
                    <div class="result-info">
                        <div class="result-name">
                            ${result.properties.name || 
                              result.properties.identifier || 
                              result.properties.iata || 
                              'Unknown'}
                        </div>
                        <div class="result-details">
                            ${result.properties.iata ? `<span>IATA: ${result.properties.iata}</span>` : ''}
                            ${result.properties.icao ? `<span>ICAO: ${result.properties.icao}</span>` : ''}
                            ${result.properties.type ? `<span>Type: ${result.properties.type}</span>` : ''}
                            ${result.properties.city ? `<span>City: ${result.properties.city}</span>` : ''}
                        </div>
                    </div>
                    <button class="zoom-to-btn" data-index="${index}">
                        <i class="fas fa-map-marker-alt"></i>
                    </button>
                </div>
            `).join('')}
        </div>
    `;
    
    // Style the popup
    popup.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        border-radius: 10px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        z-index: 10004;
        width: 400px;
        max-height: 500px;
        overflow: hidden;
        border: 2px solid #1a73e8;
    `;
    
    document.body.appendChild(popup);
    
    // Add close button event
    popup.querySelector('.close-popup').addEventListener('click', () => {
        popup.remove();
    });
    
    // Add zoom buttons events
    popup.querySelectorAll('.zoom-to-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const index = parseInt(this.getAttribute('data-index'));
            const result = results[index];
            zoomToResult(result);
            popup.remove();
        });
    });
    
    // Close on background click
    setTimeout(() => {
        const overlay = document.createElement('div');
        overlay.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 10003;
        `;
        document.body.appendChild(overlay);
        
        overlay.addEventListener('click', () => {
            popup.remove();
            overlay.remove();
        });
    }, 10);
    
    // Auto-close after 15 seconds
    setTimeout(() => {
        if (popup.parentNode) {
            popup.remove();
        }
    }, 15000);
}

function getIconForType(type) {
    switch(type) {
        case 'airport': return 'fa-plane-departure';
        case 'waypoint': return 'fa-map-marker-alt';
        case 'fir': return 'fa-border-all';
        default: return 'fa-map-marker';
    }
}
        // ==================== FINAL INIT ====================
        initLayerControls();
        activateTool('select');
        updateModeUI();
        
        console.log('‚úÖ FlightFuel Application Fully Initialized with Simple Edit Tools');
        showStatus('FlightFuel ready!', 'success');
    </script>
</body>
</html>
